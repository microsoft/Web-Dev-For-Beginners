# ç€è¦½å™¨æ“´å……åŠŸèƒ½å°ˆæ¡ˆ Part 1ï¼šå­¸ç¿’èƒŒæ™¯å·¥ä½œèˆ‡æ•ˆèƒ½

## èª²å‰æ¸¬é©—

[èª²å‰æ¸¬é©—](https://happy-mud-02d95f10f.azurestaticapps.net/quiz/27?loc=zh_tw)

### å¤§ç¶±

åœ¨å‰å…©å ‚èª²ç¨‹ä¸­ï¼Œä½ å­¸æœƒå¦‚ä½•å»ºç«‹è¡¨å–®ã€é¡¯ç¤º API å›è¦†çš„è³‡æ–™åœ¨çµæœå€å¡Šä¸­ï¼Œé€™æ˜¯ç¶²é è™•ç†ç¶²é è³‡è¨Šçš„æ¨™æº–è¡Œç‚ºã€‚ä½ ç”šè‡³å­¸æœƒäº†å¦‚ä½•éåŒæ­¥æ€§åœ°æŠ“å–è³‡æ–™ã€‚ä½ çš„æ“´å……å¥—ä»¶å°±å¿«å®Œæˆäº†ã€‚

å®ƒåªå‰©ç®¡ç†èƒŒæ™¯å·¥ä½œï¼šåŒ…æ‹¬åˆ·æ–°å¥—ä»¶çš„åœ–ç¤ºé¡è‰²ï¼Œæˆ‘å€‘ä¾†è¨è«–ç€è¦½å™¨æ˜¯å¦‚ä½•è™•ç†é€™é¡çš„å·¥ä½œã€‚ä¹Ÿè®“æˆ‘å€‘æ¢è¨ä½ æ‰€å»ºç«‹çš„ç¶²é ï¼Œç€è¦½å™¨æœƒå¤šæœ‰æ•ˆåœ°è™•ç†å…¶ä¸­çš„å…§å®¹ã€‚

## ç¶²é è™•ç†æ•ˆèƒ½çš„åŸºç¤

> "ç¶²é è™•ç†æ•ˆèƒ½æ”¸é—œå…©ä»¶äº‹ï¼šç¶²é å¤šå¿«åœ°è¼‰å…¥ï¼Œèˆ‡ç¨‹å¼å¤šå¿«åœ°åŸ·è¡Œã€‚" -- [Zack Grossbart](https://www.smashingmagazine.com/2012/06/javascript-profiling-chrome-developer-tools/)

é—œæ–¼å¦‚ä½•è®“ä½ çš„ç¶²é èƒ½å¿«é€Ÿåœ°é‹ä½œåœ¨å„é¡è£ç½®ã€å„å€‹ä½¿ç”¨è€…ä»¥åŠå„ç¨®æƒ…æ³ï¼Œæ˜¯ä¸€ä»¶é›£ä»¥æƒ³åƒçš„é¾å¤§ä¸»é¡Œã€‚é€™è£¡æœ‰ä¸€äº›è¦é»ç¢ºä¿ä½ åœ¨é–‹ç™¼ç¶²é æˆ–æ˜¯æ“´å……åŠŸèƒ½æ™‚ï¼ŒéŠ˜è¨˜åœ¨å¿ƒã€‚

ç¬¬ä¸€ä»¶äº‹ç‚ºç¢ºä¿ç¶²é æ”¶é›†é—œæ–¼ç¶²é æ•ˆèƒ½çš„è³‡æ–™ï¼Œåœ¨ç€è¦½å™¨çš„é–‹ç™¼è€…å·¥å…·ä¸­å¯ä»¥å¯¦ç¾å®ƒã€‚åœ¨ Edge ä¸­ï¼Œé¸æ“‡ã€Œè¨­å®šåŠæ›´å¤šã€æŒ‰éˆ•(ç€è¦½å™¨ä¸Šä¸‰å€‹é»çš„åœ–ç¤º)ï¼Œä¸¦é¸æ“‡æ›´å¤šå·¥å…· > é–‹ç™¼äººå“¡å·¥å…·ä¸¦é–‹å•Ÿ Performance åˆ†é ã€‚ä½ ä¹Ÿå¯ä»¥ä½¿ç”¨éµç›¤å¿«æ·éµï¼ŒWindows ä¸Šçš„ `Ctrl` + `Shift` + `I` èˆ‡ Mac ä¸Šçš„ `Option` + `Command` + `I` ä¾†é–‹å•Ÿé–‹ç™¼äººå“¡å·¥å…·ã€‚

Performance åˆ†é åŒ…æ‹¬äº†æ•ˆèƒ½åˆ†æå·¥å…·ã€‚é–‹å•Ÿä¸€å€‹ç¶²é ï¼Œä¾‹å¦‚ https://www.microsoft.com ï¼Œé»æ“Š 'Record' æŒ‰éˆ•ä¸¦é‡æ–°æ•´ç†ç¶²é ã€‚åœæ­¢éŒ„è£½å¾Œä½ å°±èƒ½å–å¾—ç¶²é çš„ 'script'ã€'render' èˆ‡ 'paint' çš„éç¨‹èˆ‡è³‡è¨Šï¼š

![Edge æ€§èƒ½åˆ†æå·¥å…·](../images/profiler.png)

âœ… é€ è¨ª [Microsoft æ–‡ä»¶](https://docs.microsoft.com/en-us/microsoft-edge/devtools-guide/performance?WT.mc_id=academic-13441-cxa)è§€çœ‹ Edge çš„ Performance åˆ†é è³‡è¨Š

> æç¤ºï¼šè¦å–å¾—çœŸæ­£çš„ç¶²é é–‹å•Ÿæ™‚é–“ï¼Œè¨˜å¾—æ¸…é™¤ä½ çš„ç€è¦½å™¨å¿«å–ã€‚

é¸æ“‡ä¸€æ¨£ç¶²é åœ¨è¼‰å…¥æ™‚ï¼Œæ™‚é–“åˆ—ä¸­å‡ºç¾çš„äº‹ä»¶ç‰©ä»¶ã€‚

è§€çœ‹å®ƒçš„ç¸½è¦½é¢æ¿ä¸¦æˆªåœ–ä½ çš„ç¶²é æ•ˆèƒ½ã€‚

![Edge æ€§èƒ½åˆ†æå·¥å…·æˆªåœ–](../images/snapshot.png)

æª¢æŸ¥ Event Log é¢æ¿ï¼Œæ˜¯å¦æœ‰ç¶²é äº‹ä»¶èŠ±è¶…é 15 æ¯«ç§’ï¼š

![Edge event log](../images/log.png)

âœ… äº†è§£ä½ çš„æ€§èƒ½åˆ†æå·¥å…·ï¼åœ¨é€™å€‹ç¶²é ä¸­ï¼Œé–‹å•Ÿé–‹ç™¼è€…å·¥å…·ï¼Œæª¢æŸ¥æ˜¯å¦æœ‰ä»»ä½• bottleneckã€‚ä»€éº¼æ˜¯è¼‰å…¥æœ€ä¹…çš„ç‰©ä»¶ï¼Ÿå“ªå€‹åˆæ˜¯æœ€å¿«çš„ï¼Ÿ

## æ•ˆèƒ½åˆ†æ

ç¸½é«”è€Œè¨€ï¼Œæ¯ä¸€ä½ç¶²é é–‹ç™¼è€…ä¸€å®šè¦æ³¨æ„ä¸€äº›ã€Œæœ‰å•é¡Œçš„åœ°æ–¹ã€ï¼Œé¿å…åœ¨ç™¼å¸ƒä½œå“æ™‚æœ‰ä»¤äººæ„æƒ³ä¸åˆ°çš„é©šå–œã€‚

**è³‡ç”¢(Asset)å¤§å°**ï¼šéå»å¹¾å¹´ä¾†ï¼Œç¶²é ã€Œè®Šé‡ã€äº†ï¼Œä¹Ÿå› æ­¤è®Šæ…¢äº†ã€‚æœ‰äº›è² æ“”ä¾†è‡ªæ–¼åœ–ç‰‡çš„ä½¿ç”¨ã€‚

âœ… æŸ¥è©¢ [Internet Archive](https://httparchive.org/reports/page-weight)ï¼Œçœ‹çœ‹éå»çš„ç¶²é è² æ“”ç­‰è³‡è¨Šã€‚

ä¸€å€‹å¥½çš„ç¿’æ…£æ˜¯ç¢ºä¿ä½ çš„åœ–ç‰‡æœ‰åšæœ€ä½³åŒ–ï¼Œå‘ˆç¾åˆç†çš„æª”æ¡ˆå¤§å°åŠè§£æåº¦å½±åƒçµ¦ä½ çš„ä½¿ç”¨è€…ã€‚

**DOM æŸ¥æ‰¾å…ƒç´ (Traversal)**ï¼šç€è¦½å™¨å¿…é ˆä¾ç…§ä½ çš„ç¨‹å¼ç¢¼å»ºç«‹ Document Object Modelï¼Œè«‹ç¢ºä¿ä½ çš„ tags æœ€å°åŒ–ï¼Œç¶²é åªä½¿ç”¨å¿…é ˆçš„åŠŸèƒ½èˆ‡é€ å‹ã€‚å¦å¤–ï¼Œéé‡çš„ç¶²é  CSS ä¹Ÿå¯ä»¥è¢«æœ€ä½³åŒ–ï¼Œèˆ‰ä¾‹ä¾†èªªï¼Œé€ å‹æ¨£æ¿åªç”¨åœ¨å–®é ä¸Šï¼Œè€Œéå…¨åŸŸä¸Šã€‚

**JavaScript**ï¼šæ¯ä¸€ä½ JavaScript é–‹ç™¼è€…æœƒè§€å¯Ÿ 'render-blocking' è…³æœ¬ï¼Œå®ƒæœƒåœ¨ DOM æŸ¥æ‰¾èˆ‡ç€è¦½å™¨å‘ˆç¾å‰è¢«è¼‰å…¥å¥½ã€‚è«‹è€ƒæ…®ä½¿ç”¨ `defer` åœ¨ä½ çš„ç¨‹å¼ç¢¼ä¸­ï¼Œæˆ‘å€‘çš„ç›†æ ½ç›’å°ˆæ¡ˆå°±æœ‰å¯¦è¸é€™è¡Œã€‚

âœ… åœ¨[ç¶²é æ¸¬é€Ÿç¶²](https://www.webpagetest.org/)ä¸Šæ¸¬è©¦ä¸€äº›ç¶²é ï¼Œå­¸ç¿’ç¢ºèªç¶²é æ•ˆèƒ½çš„åŸºæœ¬æª¢æŸ¥ã€‚

ç¾åœ¨ä½ äº†è§£ç€è¦½å™¨å¦‚ä½•å‘ˆç¾ä½ æ‰€æä¾›çš„è³‡ç”¢ï¼Œæˆ‘å€‘ä¾†çœ‹çœ‹æˆ‘å€‘çš„æ“´å……åŠŸèƒ½æœ€å¾Œéœ€è¦è£œé½Šçš„é …ç›®ï¼š

### å»ºç«‹å‡½å¼è¨ˆç®—é¡è‰²

ç·¨è¼¯ `/src/index.js`ï¼Œæ–°å¢å‡½å¼ `calculateColor()` åœ¨ä¸€ç³»åˆ—ç‚ºäº† DOM å­˜å–çš„ `const` è®Šæ•¸ä¹‹å¾Œï¼š

```JavaScript
function calculateColor(value) {
	let co2Scale = [0, 150, 600, 750, 800];
	let colors = ['#2AA364', '#F5EB4D', '#9E4229', '#381D02', '#381D02'];

	let closestNum = co2Scale.sort((a, b) => {
		return Math.abs(a - value) - Math.abs(b - value);
	})[0];
	console.log(value + ' is closest to ' + closestNum);
	let num = (element) => element > closestNum;
	let scaleIndex = co2Scale.findIndex(num);

	let closestColor = colors[scaleIndex];
	console.log(scaleIndex, closestColor);

	chrome.runtime.sendMessage({ action: 'updateIcon', value: { color: closestColor } });
}
```

ç™¼ç”Ÿäº†ä»€éº¼äº‹ï¼Ÿä½ å‚³éäº† API å›å‚³çš„äºŒæ°§åŒ–ç¢³æ¿ƒåº¦æ•¸å€¼ï¼Œè¨ˆç®—å‡ºå®ƒæœ€é©åˆå°æ‡‰çš„é¡è‰²çŸ©é™£ç´¢å¼•ä½ç½®ã€‚ä¹‹å¾Œï¼Œä½ å°‡é€™å€‹é¡è‰²æ•¸å€¼å‚³çµ¦äº† chrome runtimeã€‚

chrome.runtime æœ‰[ä¸€å€‹ API](https://developer.chrome.com/extensions/runtime)è™•ç†æ‰€æœ‰çš„èƒŒæ™¯å·¥ä½œï¼Œä½ çš„æ“´å……å¥—ä»¶å€ŸåŠ©äº†æ­¤åŠŸèƒ½ï¼š

> "åœ¨æ‡‰ç”¨ç¨‹å¼ä¸­ï¼Œä½¿ç”¨ chrome.runtime API ä¾†æ¥æ”¶èƒŒæ™¯é é¢ï¼Œå›å‚³é—œæ–¼ manifest çš„è³‡è¨Šï¼Œç›£è½ä¸¦å›æ‡‰äº‹ä»¶ã€‚ä½ ä¹Ÿå¯ä»¥åˆ©ç”¨æ­¤ API è½‰æ› URL çš„ç›¸å°è·¯å¾‘æˆçµ•å°è·¯å¾‘ã€‚"

âœ… å¦‚æœä½ æ­£æ‰“ç®—é–‹ç™¼æ­¤å°ˆæ¡ˆçµ¦ Edge ç€è¦½å™¨ä¸Šä½¿ç”¨ï¼Œä½ æœƒè¨ç•°ä½ ä½¿ç”¨çš„æ˜¯ chrome APIã€‚æ–°çš„ Edge ç€è¦½å™¨åŸ·è¡Œåœ¨ Chromium browser å¼•æ“ä¸Šï¼Œæ‰€ä»¥ä½ ä¹Ÿèƒ½ä½¿ç”¨é€™äº›å·¥å…·ã€‚

> æ³¨æ„ï¼Œå¦‚æœä½ æƒ³è¦å‰–æç€è¦½å™¨æ“´å……åŠŸèƒ½ï¼Œè«‹åœ¨æ“´å……å¥—ä»¶ä¸ŠåŸ·è¡Œé–‹ç™¼è€…å·¥å…·ï¼Œå®ƒèˆ‡ç€è¦½å™¨ä¸»è¦–çª—ç‚ºä¸åŒçš„å€‹é«”ã€‚

### è¨­å®šåœ–ç¤ºé è¨­é¡è‰²

ç¾åœ¨ï¼Œåœ¨å‡½å¼ `init()` ä¸­ï¼Œåˆ©ç”¨å‘¼å« chrome `updateIcon` è¨­å®šåœ–ç¤ºé¡è‰²ç‚ºé€šç”¨ç¶ ï¼š

```JavaScript
chrome.runtime.sendMessage({
	action: 'updateIcon',
		value: {
			color: 'green',
		},
});
```
### å‘¼å«å‡½å¼ã€åŸ·è¡Œå‘¼å«

æ¥ä¸‹ä¾†ï¼Œåœ¨ C02Signal API å›å‚³çš„ promise ç‰©ä»¶ä¸‹æ–¹å‘¼å«å‡½å¼ï¼š

```JavaScript
//let CO2...
calculateColor(CO2);
```
æœ€å¾Œï¼Œåœ¨æª”æ¡ˆ `/dist/background.js` ä¸­ï¼Œæ–°å¢äº‹ä»¶ç›£è½è€…çµ¦é€™äº›èƒŒæ™¯è¡Œç‚ºçš„å‘¼å«ï¼š

```JavaScript
chrome.runtime.onMessage.addListener(function (msg, sender, sendResponse) {
	if (msg.action === 'updateIcon') {
		chrome.browserAction.setIcon({ imageData: drawIcon(msg.value) });
	}
});
//åƒè€ƒ energy lollipop extensionï¼Œå¾ˆå¥½çš„ç¨‹å¼ï¼
function drawIcon(value) {
	let canvas = document.createElement('canvas');
	let context = canvas.getContext('2d');

	context.beginPath();
	context.fillStyle = value.color;
	context.arc(100, 100, 50, 0, 2 * Math.PI);
	context.fill();

	return context.getImageData(50, 50, 100, 100);
}
```
åœ¨æ­¤ç¨‹å¼ä¸­ï¼Œä½ å»ºç«‹äº†äº‹ä»¶ç›£è½è€…çµ¦ä»»ä½•å‰åˆ°èƒŒæ™¯å·¥ä½œç®¡ç†è€…çš„è¨Šæ¯ã€‚è‹¥ 'updateIcon' è¢«å‘¼å«ï¼Œå‰‡æ¥ä¸‹ä¾†çš„ç¨‹å¼æœƒè¢«åŸ·è¡Œï¼Œåˆ©ç”¨ Canvas API ç¹ªè£½å‡ºå°æ‡‰é¡è‰²çš„åœ–ç¤ºã€‚

âœ… ä½ æœƒå­¸ç¿’æ›´å¤šé—œæ–¼ Canvas API åœ¨å¾€å¾Œçš„[å¤ªç©ºéŠæˆ²èª²ç¨‹](../../../6-space-game/2-drawing-to-canvas/translations/README.zh-tw.md)ã€‚

ç¾åœ¨ï¼Œé‡æ–°å»ºåˆ¶ä½ çš„æ“´å……åŠŸèƒ½(`npm run build`)ï¼Œåˆ·æ–°ä¸¦é‹è¡Œä½ çš„å¥—ä»¶ï¼Œè§€å¯Ÿåœ–ç¤ºçš„é¡è‰²è®ŠåŒ–ã€‚ç¾åœ¨æ˜¯æ™‚å€™å»è·‘è…¿æˆ–æ˜¯æ´—ç¢—å—ï¼Ÿç¾åœ¨ä½ çŸ¥é“äº†ï¼

æ­å–œä½ ï¼Œä½ å·²ç¶“å»ºç«‹äº†ä¸€æ¬¾å¯¦ç”¨çš„ç€è¦½å™¨æ“´å……åŠŸèƒ½ï¼Œä¸¦å­¸åˆ°æ›´å¤šç€è¦½å™¨çš„é‹ä½œæ–¹å¼èˆ‡ç›£æ¸¬å®ƒçš„æ•ˆèƒ½åˆ†æã€‚

---

## ğŸš€ æŒ‘æˆ°

èª¿æŸ¥ä¸€äº›æ‚ ä¹…çš„é–‹æºç¶²ç«™ï¼Œä¸¦æ ¹æ“šå®ƒå€‘çš„ GitHub æ­·å²ï¼Œä½ èƒ½åˆ†è¾¨å®ƒå€‘éå»å¹¾å¹´ä»¥ä¾†æ•ˆèƒ½ä¸Šçš„èª¿æ•´å—ï¼Ÿä»€éº¼å®ƒå€‘æ˜¯å…±åŒçš„ç—›é»ï¼Ÿ

## èª²å¾Œæ¸¬é©—

[èª²å¾Œæ¸¬é©—](https://happy-mud-02d95f10f.azurestaticapps.net/quiz/28?loc=zh_tw)

## è¤‡ç¿’èˆ‡è‡ªå­¸

è«‹è€ƒæ…®è¨»å†Š[performance newsletter](https://perf.email/)

èª¿æŸ¥ç€è¦½å™¨æ¸¬é‡ç¶²é æ•ˆèƒ½çš„æ–¹æ³•ï¼ŒæŸ¥çœ‹é–‹ç™¼è€…å·¥å…·å…§çš„ Performance åˆ†é ã€‚ä½ èƒ½æ‰¾åˆ°ä»€éº¼å·¨å¤§çš„å·®åˆ¥å—ï¼Ÿ

## ä½œæ¥­

[åˆ†æç¶²é æ•ˆèƒ½](assignment.zh-tw.md)

